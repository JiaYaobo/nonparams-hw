---
title: "非参大作业"
author: "吕良波，朱彦融"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r setup, include=FALSE} 
#取消warning
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

## 大作业得分序列部分

希望采用符号检验的方法发现局点，思路是通过遍历每一局比赛的各个回合，比较该回合前后的比赛表现，从而得出这个点是否是局势（得分率）发生显著变化的点，也就是局点

这样又分成两种情况，对每次我们遍历的一个回合，我们既可以选择观察这个回合前后对称的某一些回合的得分率变化，也可以选择观察这个回合之前所有回合和其后的所有回合的得分率的变化，这样就可以分为对称比较的符号检验和非对称比较的符号检验，对于实际的排球比赛而言，一个回合对职业选手而言应当不能作用于整局比赛，应当只对接下来的一定范围的回合产生影响，因而我们采用对称比较的符号检验

```{r}
#读入数据
dt<-read.csv("/Users/jiayaobo/PycharmProjects/nonparams/groupwork/volleyball.csv", encoding = "utf-8")
g1<-dt[dt$`局数`==1,1]
g2<-dt[dt$`局数`==2,1]
g3<-dt[dt$`局数`==3,1]
g4<-dt[dt$`局数`==4,1]
g5<-dt[dt$`局数`==5,1]
```

对于回合i，以r为半径，比较第i-r到i-1和i+1到i+r的得分率变化，这样需要规定一个半径，而对于实际的排球比赛，场面、士气、环境等因素瞬息万变，因此一个固定的半径是不大可行的,因此我们可以选择多个半径进行分析。因此可以编写以下函数。

```{r}
# 对称观察
sym_sign_test<-function (radius, data){
  sign_test_seq<-c()
  for(i in (radius+1):(length(data)-radius)){ # 遍历第r+1到第n-r个数据
    pos_pre<-sum(data[(i-radius):(i-1)]) # 前r场得分
    p<-pos_pre/radius # 前r场得分率
    sign_test_seq<-c(sign_test_seq,binom.test(sum(data[(i+1):(i+radius)]),radius,p=p)$p.value) # 返回p值向量
  }
  return (sign_test_seq)
}

# 绘制p值图像
pval_plot<-function (p_seq,r){
  n<-length(p_seq)
  x<-seq(r+1,n+r)
  plot(x,p_seq) # 画出回合数和p值的散点图
  abline(0.05,0 , col="green") # 画出pvalue=0.05 的线
}
```

### 接下来对第一局进行分析

```{r}
for(r in 5:10){
  res<-sym_sign_test(r,g1)
  print(paste0("radius is : ",r," the round of pvalue<0.05 : ",(which(res<0.05)+r)))
  pval_plot(res, r)
}

```

根据图像可知大概在18、19、20回合前后，第一局的局势发生了改变，通过分析原数据可知

当观察半径为6时，第18回合被认为是局点，这一回合被对手得分，其前6回合分别为0、0、1、0、0、0即中国队只拿了一分，得分率为16.7%，而后6回合为1、0、1、0、1、1得分率为66.7%，中国队即使调整，防止比分进一步被对方拉大

当观察半径为7时，第19回合被认为是局点，这一回合我方得分，其前7回合分别为0、0、1、0、0、0、0，我方只得一分，得分率为14.3%,而后7回合为0、1、0、1、1、0、1得分率为57.14%,从被对方压倒性领先到将局势扭转到有利于自己一面

当观察半径为8时，第18、20回合都被认为是局点，当观察半径为9时，第19回合被认为是局点，与之前的分析同样，是得分率由大幅度落后到领先

这些分析表明虽然中国队在后期扭转了一些前期劣势，但是由于这个转变或者局点发生的时间较晚，导致对方前期建立的优势过大，而后期我方的优势无法抵消前期犯下的错误，因而输掉了第一局

### 接下来对第二局进行分析

```{r}
for(r in 5:15){
  res<-sym_sign_test(r,g2)
  print(paste0("radius is : ",r," the round of pvalue<0.05 : ",(which(res<0.05)+r)))
  pval_plot(res, r)
}
```

发现无论如何扩大观察半径，实际上我们都无法找出在0.05显著性水平下的局点，结合胜率的分析，第二局双方较为僵持，中国队在僵持局面中掌握了微弱优势并且保持了下去。

### 接下来对第三局进行分析

```{r}
for(r in 5:10){
  res<-sym_sign_test(r,g3)
  print(paste0("radius is : ",r," the round of pvalue<0.05 : ",(which(res<0.05)+r)))
  pval_plot(res, r)
}
```


当观察半径为5时，第20、21回合都被认为是局点，对第20回合回合被对手得分，其前5回合分别为0、0、0、0、0被对手连拿5分，而后5回合为1、0、0、1、0中国队及时调整，阻止了对方连续得分的强势，但是仍然造成了不小的分差；对第21回合，与第20回合的结果相近

当观察半径为6时，第21回合被认为是局点，其前5回合分别为0、0、0、0、0、0被对手连拿6分，而后6回合为0、0、1、0、1、0, 与半径为5时情况类似

当观察半径为7、8、9时，第10回合都被认为是局点，其前9回合分别为0 1 1 1 1 0 1 0 1中国队开局局势大好，而后9回合为0 1 0 1 0 0 0 0 0中国队未能保持优势，反而被对方将优势消耗殆尽。而第9、11、12、13回合的情形与第10回合类似，都是中国队先有优势然后转为劣势。

当观察半径为9、10时 第23、24、25回合入选，我们观察一下24回合前后10局，前10局1 0 0 0 0 0 0 1 0 0,后10局 0 1 0 1 0 0 0 1 1 0 此时中国队已陷入劣势，即使有有一些反击但是分差已经越来越大

从上述分析可以得知虽然中国队早早在第三局开局取得优势，但是很快由胜即衰，一直处于劣势局面，最终大比分输掉了第三局

### 接下来分析第四局

```{r}
for(r in 5:10){
  res<-sym_sign_test(r,g4)
  print(paste0("radius is : ",r," the round of pvalue<0.05 : ",(which(res<0.05)+r)))
  pval_plot(res, r)
}
```

整体来看我们发现第四局的局点在半径较小时处于33回合附近，而半径较大时处于42回合左右

我们观察34回合前后7局，前7局1 1 1 0 1 0 1,后7局0 0 0 1 0 0 0,表明中国队由优势局面转变为了落后局面

观察42回合前后10局，前10局 0 1 0 0 0 0 1 0 0 0,中国队落后很多，后10局 1 0 1 1 1 0 0 1 0 1,中国队奋起直追，追回了一些劣势

发现第四局中国队是先优势再劣势又优势的局面，挽回了中局时一度的败局，最终取得了第四局的胜利

### 接下来分析第五局

```{r}
for(r in 5:10){
  res<-sym_sign_test(r,g5)
  print(paste0("radius is : ",r," the round of pvalue<0.05 : ",(which(res<0.05)+r)))
  pval_plot(res, r)
}
```

发现我们无法找出在0.05显著性水平下的局点，第五局作为决胜局，双方僵持不下，更是达到了第32回合才决出胜负，但是中国对欠缺了一些运势，输掉了整场比赛。

纵观整场比赛，从得分序列对称比较的符号检验分析来看，中国队主要失败的原因是不能有效的将"优势"转变为"胜势"，也很难力挽狂澜，将败局逆转。输掉的比赛均是因为劣势期的连续失分太多，在优势期已经没有时间扳回。

## 大作业胜率分析部分
&emsp;&emsp;我们将中国队的得分与失分看作0-1马尔科夫链并计算对应的状态转移矩阵。由矩阵我们可以得到:
\begin{equation}
P_{00}=\frac{n_{00}}{n_{00}+n_{01}}   \hspace{5em}     P_{11}=\frac{n_{11}}{n_{11}+n_{10}}
\end{equation}
其中，n表示在过往回合记录的总和。由上以及胜率公式我们可以计算出对应的胜率为:
\begin{equation}
P_1=\frac{1-P_{00}}{2-P_{00}-P_{11}}
\end{equation}
因此，我们根据胜率计算公式计算5局的胜率并进行作图分析。
```{r fig.width=6, fig.height=6, fig.align='center'}
#读入数据
setwd("D:/统计/非参与半参/homework/排球比赛案例/排球比赛案例")
data=read.csv("volleyball.csv",encoding="UTF-8")
```
```{r}
#将数据五局分开
column=data[,2]
score1=data[column==1,1]
score2=data[column==2,1]
score3=data[column==3,1]
score4=data[column==4,1]
score5=data[column==5,1]
```
```{r}
#设定函数计算每一阶段的胜率
scorefunction=function(s){
  #计算过往比赛记录
  n00=0
  n11=0
  n10=0
  n01=0
  P00=0
  P11=0
  #胜率向量
  winpro=rep(0,length(s)-1)
  for(i in 2:length(s)){
    #每一个记录和前一个进行比较不断计算对应的胜率
    if(s[i-1]==0 && s[i]==0){
      n00=n00+1
    }
    else if(s[i-1]==1 && s[i]==0){
      n10=n10+1
    }
    else if(s[i-1]==0 && s[i]==1){
      n01=n01+1
    }
    else{
      n11=n11+1
    }
    #计算P00和P11，当分母为0时，我们认为对应的值为0
    if(n00+n01>0){
      P00=n00/(n00+n01)
    }
    if(n11+n10>0){
      P11=n11/(n11+n10)
    }
    winpro[i-1]=(1-P00)/(2-P00-P11)
  }
    return(winpro)
}
```
```{r fig.width=6, fig.height=6, fig.align='center'}
#做出对应的图象
plt=function(s,string,title){
x=c(1:(length(s)-1))
y=scorefunction(s)
plot(x,y,ylim = c(0.2,1),type="o",pch=16,col=string,xlab = "回合数",ylab="胜率",main=title)
abline(h=0.5)
}
plt(score1,"limegreen","第一局比赛")
plt(score2,"skyblue","第二局比赛")
plt(score3,"red","第三局比赛")
plt(score4,"limegreen","第四局比赛")
plt(score5,"skyblue","第五局比赛")

```
&emsp;&emsp;我们首先定义局点。我们认为在一局中局点代表了个体能力的转折时刻，同时也代表了相对能力的转折时刻。因此我们从中衍生出两种不同的定义方式。对于任意一个队，他们胜率的局点定义为胜率发生显著转折的时刻。或者，对于任意一个队，他们胜率的局点定义为相对优势发生明显变化的时刻。我们在下面对这两种定义进行一一阐释。

&emsp;&emsp;第一种定义：胜率发生显著转折意味着我们从该局点之后，我们可以得到在较长时间内胜率整体发展趋势的方向保持不变，可以理解为一个连续函数显著变化的极大值和极小值点。在第一场、第二场比赛的初期我们可以看到，中国队的胜率先下降后上升，说明在开始阶段中国队可能需要一定的时间去慢热。而后面三局的初期，中国队的胜率小幅度上升之后迎来了较大的跌幅。因此我们可以将这几局初期的时刻定义为局点，在这个时刻，一方面由于数据量较少，胜率的计算变化幅度较大，另一方面，也与运动员在一局初的状态相关。当然我们可以看到在每一局的后期，中国队的胜率趋向平稳，一方面说明两队的实力相当，另一方面，也可以反映出两队的心理素质相对较高，没有出现溃败的情况。

&emsp;&emsp;第二种定义：相对优势发生明显变化的时刻定义为在这个时刻之后，所在队伍的胜率在较长的时间段内保持在0.5以上或者以下，与时刻之前的胜率分布发生较大变化。保持在0.5以上，说明在球技、手感等状态中占据优势，更有可能赢下该局，保持在0.5以下，说明在以上状态中占据劣势，需要调整和反思。在图中我们将胜率为0.5的直线画出。我们可以看到，在第一局中，中国队的胜率基本都在0.5以下，可能是因为中国队状态没有进入的原因。而后面几局中显著的局点出现在第二局的中后期和第三局的中期，第二期中后期，中国队的胜率基本持续保持在0.5以上，一转之前的颓势，而第三局中期之后，中国队的胜率持续低于0.5，在第三局有被一击而溃的情况出现，到后期队员的心态可能也受到了较大的影响。而在第四局和第五局中国队的比拼相对焦灼，在这个时候，我们所定义的局点并没有显著的出现。

## 大作业连续游程部分

&emsp;&emsp;在排球比赛中，连续游程数具有重要意义，只有连续游程数出现，比赛才能够分出胜负。所以根据连续游程数的定义，首先先计算出每一局中国对连续得分和连续失分的回合数，再除以2，就得到了连续失分和连续得分的连续游程数；为了更加直观的看出每一局的连续游程数的变化，对每一局每一回合数的连续游程数进行描述统计分析，在每一回合中没有出现连续得分或连续失分的，即得分失分交替的回合，连续游程数记为0，故每一局都能得到一串连续游程数，将连续游程数画一个累加的折线图。

&emsp;&emsp;在两队竞争博弈的模型中，一个队得分意味着另一个队处于失分状态，此时我们通过比较中国队得分和失分的状态来比较中国队得分和对手得分的状态。通过累加的游程数的折线图，我们可以通过比较折线图的相对位置来比较两队的得失分状态。

&emsp;&emsp;我们现在来定义局点。此时我们给出两种局点的定义方式。我们认为，当局势从僵持状态到长期连续游程的出现时，连续游程的起点我们认为是局点。首先，连续游程的出现代表了一个队连续赢或者连续输的情况。只有当游程相对较长时，两队才基本跳出了原来的僵持状态，这个时候，一个很长的连续游程的起点往往是一队击垮另一队信心的起点，因此我们将他定义为局点。同时从连续游程到长期僵持状态的起始点也可以认为是起点，因为在这个时候，每个队员都应该绷紧神经，一旦松懈可能造成溃败。

&emsp;&emsp;第二种定义方式是相对而言的。我们在这里将局点定义为一队的连续游程数显著翻盘，从而超越另一队的时刻。这里的显著我们指的是刚开始这一队的连续游程数是低于另一队的，而在某个时刻，我们定义为局点的时刻，它显著超越了另一个队。我们将对应连续游程的起点定义为局点。

```{r}
#构造一个函数计算每一局中连续得分的回合数
f1=function(sc){
  s =0
  y1=sc
  run1 = rep(0,length(y1))
  for(i in 1:length(y1))
  {
    if(i<length(y1)){#先判断是否处于最后一个数据，因为最后一个数据没有下一个数据
      if(y1[i]==1){s=s+1}   #若得分则回合数加1
      if(s==1&&y1[i+1]==0){s=0}   #若只有一次得分，即下一次是失分，则接下一次循环，将s重新置为0
      if(s>1&&y1[i+1]==0){   #若连续为1 的回合数大于等于2，并且下一回合失分，则将连续得分的回合数存进去
        run1[i]=s
        s=0}
    }
    if(i==length(y1)){s=s+1  #若该数据为最后一个数据，若为得分则s加1,
    if(s>1){run1[i]=s}  #只有连续两个回合及以上才能存进去
    }
  }
  return(run1)
}
#以下为5局比赛中连续得分的连续游程数
run11=f1(score1)/2
run12=f1(score2)/2
run13=f1(score3)/2
run14=f1(score4)/2
run15=f1(score5)/2
```


```{r}
#构造一个函数计算每一局中连续失分的回合数
f0=function(sc){
  s =0
  y1=sc
  run0 = rep(0,length(y1))
  for(i in 1:length(y1))
  {
    if(i<length(y1)){  #先判断是否处于最后一个数据，因为最后一个数据没有下一个数据
      if(y1[i]==0){s=s+1}   #若失分则回合数加1
      if(s==1&&y1[i+1]==1){s=0}  #若只有一次失分，即下一次是得分，则接下一次循环，将s重新置为0
      if(s>1&&y1[i+1]==1){  #若连续为0的回合数大于等于2，并且下一回合得分，则将连续失分的回合数存进去
        run0[i]=s
        s=0}
    }
    if(i==length(y1)){s=s+1  #若该数据为最后一个数据，若为失分则s加1
    if(s>1){run0[i]=s}  #只有连续两个回合及以上才能存进去
    }
  }
  return(run0)
}
#以下为5局比赛中连续失分的连续游程数
run01=f0(score1)/2
run02=f0(score2)/2
run03=f0(score3)/2
run04=f0(score4)/2
run05=f0(score5)/2
```


```{r}
#构造函数，将游程数累加
add=function(z){
  leng=rep(0,length(z))
  for (i in 1:length(z)) {
    for(j in 1:i){
      leng[i]=leng[i]+z[j]
    }
  }
  return(leng)
}
```


### 第一局连续游程数累加图
```{r fig.width=6, fig.height=6, fig.align='center'}
score11=add(run11)
score01=add(run01)
N=max(score01,score11)
index = seq(1,length(score11),1)
plot(index,score11,type = "l",ylim=c(0,N),xlab = "回合数")
par(new=TRUE)
plot(index,score01,type = "l",col="red",main = "第一局连续游程数累加图",ylim=c(0,N),xlab=" ")
legend("topleft",legend=c("连续失分","连续得分"),col=c("red","black"),lty=1,lwd=2)
```

&emsp;&emsp;从图中可以看出，失分的连续游程数完全大于得分的连续游程数，得知中国队第一局中一直处于失利状态。并且在32回合左右时，中国队失分相对严重，已经鲜有扳回的可能。这一局中我们没有找到对应的局点。

### 第二局连续游程累加图
```{r fig.width=6, fig.height=6, fig.align='center'}
score12=add(run12)
score02=add(run02)
N=max(score02,score12)
index = seq(1,length(score12),1)
plot(index,score12,type = "l",ylim=c(0,N),xlab = "回合数")
par(new=TRUE)
plot(index,score02,type = "l",col="red",main = "第二局游程数累加图",ylim=c(0,N),xlab = " ")
legend("topleft",legend=c("连续失分","连续得分"),col=c("red","black"),lty=1,lwd=2)

```

&emsp;&emsp;从图中可以看出第二局，在22回合之前，两个队的比赛连续得分和连续失分的连续游程数相互交替，比赛还处于胶着中，但当22回合之后，比赛的失分的连续游程数就完全超过了得分的连续游程数，并且持续到比赛结束，所以根据局点的第一种定义，22回合左右是局点。


### 第三局连续游程累加图
```{r fig.width=6, fig.height=6, fig.align='center'}
score13=add(run13)
score03=add(run03)
N=max(score03,score13)
index = seq(1,length(score13),1)
plot(index,score13,type = "l",ylim=c(0,N),xlab = "回合数")
par(new=TRUE)
plot(index,score03,type = "l",col="red",main = "第三局游程数累加图",ylim=c(0,N),xlab = " ")
legend("topleft",legend=c("连续失分","连续得分"),col=c("red","black"),lty=1,lwd=2)
```

&emsp;&emsp;从图中可以看出，在20回合之前，连续得分的连续游程数明显高于失分的连续游程数，但在20回合之后，失分的连续游程急剧增大，完全超过了得分的连续游程数，且这种状态持续到比赛结束，比赛的输赢翻转，即20回合左右是局点。

### 第四局游程数累加图
```{r fig.width=6, fig.height=6, fig.align='center'}
score14=add(run14)
score04=add(run04)
N=max(score04,score14)
index = seq(1,length(score14),1)
plot(index,score14,type = "l",ylim=c(0,N),xlab = "回合数")
par(new=TRUE)
plot(index,score04,type = "l",col="red",main = "第四局游程数累加图",ylim=c(0,N),xlab = " ")
legend("topleft",legend=c("连续失分","连续得分"),col=c("red","black"),lty=1,lwd=2)
```

&emsp;&emsp;从图中可以看出第四局，在37回合之前得分的连续游程数一直高于失分的连续游程数，但在37回合之后,47回合之前，失分的连续游程数就开始持续高于连续得分的连续游程数，故37回合左右可以作为局点；

&emsp;&emsp;在37回合到52回合之前又开始了得分失分交替，比赛胶着中，但是在52回合之后，得分占优势，超过了连续失分的连续游程数，持续到比赛结束，故52回合左右也是局点。


### 第五局游程数累加图

```{r fig.width=6, fig.height=6, fig.align='center'}
score15=add(run15)
score05=add(run05)
N=max(score05,score15)
index = seq(1,length(score15),1)
plot(index,score15,type = "l",ylim=c(0,N),xlab = "回合数")
par(new=TRUE)
plot(index,score05,type = "l",col="red",main = "第五局游程数累加图",ylim=c(0,N),xlab = " ")
legend("topleft",legend=c("连续失分","连续得分"),col=c("red","black"),lty=1,lwd=2)
```


&emsp;&emsp;从图中可以看出第五局，在25回合之前，得分一直占优势，完全不低于失分的连续游程数，但在25回合之后，失分的连续游程数反超了得分的连续游程数，且持续到比赛结束，故25回合打破了之前得分的优势状态，失分开始占据优势地位，故25回合左右是局点。


### 连续游程数整合

```{r}
name =c("第一局","第二局","第三局","第四局","第五局")
start = c("0:3","1.5:2","2:1","3:2","1:1")
meaian = c("1:1.5","2.5:2","0:4","1.5:4.5","3:2")
end=c("2.5:3.5","3.5:2","1:3.5","4.5:1","1:3")
dat = data.frame(name,start,meaian,end)
colnames(dat)=c("局数","开局","局中","局末")

library(kableExtra)
dat %>% 
  kable(format = "html", escape = F) %>%
  kable_styling("striped", full_width = F)

```
&emsp;&emsp;从上述表中可以看出，在第一局中，中国队一直处于劣势，但是两个队之间的差距越来越小，开局连续失分可能是队员进入比赛状态相对较慢，且有一些新队员心理素质还不成熟，略显紧张。到第二局中后半段状态就恢复了，开始占据优势，但到第三局中后半断状态发生巨大变化，出现了溃败的情况。第四五局相对焦灼，在劣势与优势中两个队不断变换。

&emsp;&emsp;因此总的来说，一方面中国队开局的状态不是特别理想，另一方面在比赛中可能出现溃败的情况。但同时我们也看到中国队逆转翻盘的场景。因此，中国队应该首先加快进入状态的速度，尽量以少的牺牲进入比赛。另外，被别人超越时也应该要持续保持状态，不能因为连续的失分而失去信心，最终丢掉比赛，调整比赛状态和心态是很重要的。

## 综合分析与思考

我们分别从得分序列、胜率序列以及游程序列的角度对局点进行了定义和分析，不论是那种局点的定义，都体现了一种排球比赛中局势上的变化，不论是优势到劣势还是劣势到优势，因为优势意味着得分多，劣势意味着得分少，这几种局点定义的方式在本质上是相似的，而得到的各自的局点又互有补充。

更进一步思考不同局点的定义和分析结果，我们发现局点的定义大概可以分为两类，一类是单点影响局点——（胜率）以及 连续影响局点——（游程、得分序列）

这是很好理解的，因为从胜率角度分析局点，我们利用的都是该点之前回合得分的信息，得到这一点处的胜率状况，是单纯利用先验信息的

而从游程和得分序列的角度看，我们既利用了该点前的信息，同时又结合了该点后的信息，在先验信息的前提下结合后验信息的，因此这个局点影响可以成是周围信息的统计量，因而是作用于连续回合的

从分析结果来看，总体而言，中国队的主要问题集中在慢热、稳定性和临时调整方面

中国队在第一局初期就处于劣势，最终全局崩溃，而第二局仍然开局不利，直到第三、四局才逐渐开局掌握优势，从这点上看中国对是慢热的；

另一方面中国队稳定性不足，从第三、四、五局可以看出中国队一开始占据优势，却难以保持，在中局不断给对手机会，导致输掉了第三局和最后的第五局；

从临时调整方面，中国队面对对手连续追分以及优势削减缺乏及时调整，在优势期面对对手发力缺乏应对手段而丧失优势，导致劣势期丢分过多，无法在有限回合内追上。

