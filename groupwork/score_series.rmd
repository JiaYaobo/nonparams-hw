---
title: "R Notebook"
output: html_document
---
```{r}
dt<-read.csv("/Users/jiayaobo/PycharmProjects/nonparams/groupwork/volleyball.csv", encoding = "utf-8")
g1<-dt[dt$`局数`==1,1]
g2<-dt[dt$`局数`==2,1]
g3<-dt[dt$`局数`==3,1]
g4<-dt[dt$`局数`==4,1]
g5<-dt[dt$`局数`==5,1]
```

希望采用符号检验的方法发现局点，思路是通过遍历每一局比赛的各个回合，比较该回合前后的比赛表现，从而得出这个点是否是局势（得分率）发生显著变化的点，也就是局点

这样又分成两种情况，对每次我们遍历的一个回合，我们既可以选择观察这个回合前后对称的某一些回合的得分率变化，也可以选择观察这个回合之前所有回合和其后的所有回合的得分率的变化，这样就可以分为对称比较的符号检验和非对称比较的符号检验，对于实际的排球比赛而言，一个回合对职业选手而言应当不能作用于整局比赛，应当只对接下来的一定范围的回合产生影响，因而我们采用对称比较的符号检验

对于回合i，以r为半径，比较第i-r到i-1和i+1到i+r的得分率变化，这样需要规定一个半径，而对于实际的排球比赛，场面、士气、环境等因素瞬息万变，因此一个固定的半径是不大可行的,因此我们可以选择多个半径进行分析。因此可以编写以下函数。

```{r}
# 对称观察
sym_sign_test<-function (radius, data){
  sign_test_seq<-c()
  for(i in (radius+1):(length(data)-radius)){
    pos_pre<-sum(data[(i-radius):(i-1)]) # 前r场得分
    p<-pos_pre/radius # 前r场得分率
    sign_test_seq<-c(sign_test_seq,binom.test(sum(data[(i+1):(i+radius)]),radius,p=p)$p.value)
  }
  return (sign_test_seq)
}



# 绘制p值图像
pval_plot<-function (p_seq,r){
  n<-length(p_seq)
  x<-seq(r+1,n+r)
  plot(x,p_seq)
  abline(0.05,0 , col="green")
}
```

接下来对第一局进行分析

```{r}
for(r in 5:10){
  res<-sym_sign_test(r,g1)
  print(paste0("radius is : ",r," the round of pvalue<0.05 : ",(which(res<0.05)+r)))
  pval_plot(res, r)
}

```

根据图像可知大概在18、19、20回合前后，第一局的局势发生了改变，通过分析原数据可知

当观察半径为6时，第18回合被认为是局点，这一回合被对手得分，其前6回合分别为0、0、1、0、0、0即中国队只拿了一分，得分率为16.7%，而后6回合为1、0、1、0、1、1得分率为66.7%，中国队即使调整，防止比分进一步被对方拉大

当观察半径为7时，第19回合被认为是局点，这一回合我方得分，其前7回合分别为0、0、1、0、0、0、0，我方只得一分，得分率为14.3%,而后7回合为0、1、0、1、1、0、1得分率为57.14%,从被对方压倒性领先到将局势扭转到有利于自己一面

当观察半径为8时，第18、20回合都被认为是局点，当观察半径为9时，第19回合被认为是局点，与之前的分析同样，是得分率由大幅度落后到领先

这些分析表明虽然中国队在后期扭转了一些前期劣势，但是由于这个转变或者局点发生的时间较晚，导致对方前期建立的优势过大，而后期我方的优势无法抵消前期犯下的错误，因而输掉了第一局

接下来对第二局进行分析

```{r}
for(r in 5:15){
  res<-sym_sign_test(r,g2)
  print(paste0("radius is : ",r," the round of pvalue<0.05 : ",(which(res<0.05)+r)))
  pval_plot(res, r)
}
```

发现无论如何扩大观察半径，实际上我们都无法找出在0.05显著性水平下的局点，结合胜率的分析，第二局双方较为僵持，中国队在僵持局面中掌握了微弱优势并且保持了下去。

接下来对第三局进行分析

```{r}
for(r in 5:10){
  res<-sym_sign_test(r,g3)
  print(paste0("radius is : ",r," the round of pvalue<0.05 : ",(which(res<0.05)+r)))
  pval_plot(res, r)
}
```

当观察半径为5时，第20、21回合都被认为是局点，对第20回合回合被对手得分，其前5回合分别为0、0、0、0、0被对手连拿5分，而后5回合为1、0、0、1、0中国队及时调整，阻止了对方连续得分的强势，但是仍然造成了不小的分差；对第21回合，与第20回合的结果相近

当观察半径为6时，第21回合被认为是局点，其前5回合分别为0、0、0、0、0、0被对手连拿6分，而后6回合为0、0、1、0、1、0, 与半径为5时情况类似

当观察半径为7、8、9时，第10回合都被认为是局点，其前9回合分别为0 1 1 1 1 0 1 0 1中国队开局局势大好，而后9回合为0 1 0 1 0 0 0 0 0中国队未能保持优势，反而被对方将优势消耗殆尽。而第9、11、12、13回合的情形与第10回合类似，都是中国队先有优势然后转为劣势。

当观察半径为9、10时 第23、24、25回合入选，我们观察一下24回合前后10局，前10局1 0 0 0 0 0 0 1 0 0,后10局 0 1 0 1 0 0 0 1 1 0 此时中国队已陷入劣势，即使有有一些反击但是分差已经越来越大

从上述分析可以得知虽然中国队早早在第三局开局取得优势，但是很快由胜即衰，一直处于劣势局面，最终大比分输掉了第三局

接下来分析第四局

```{r}
for(r in 5:10){
  res<-sym_sign_test(r,g4)
  print(paste0("radius is : ",r," the round of pvalue<0.05 : ",(which(res<0.05)+r)))
  pval_plot(res, r)
}
```

整体来看我们发现第四局的局点在半径较小时处于33回合附近，而半径较大时处于42回合左右

我们观察34回合前后7局，前7局1 1 1 0 1 0 1,后7局0 0 0 1 0 0 0,表明中国队由优势局面转变为了落后局面

观察42回合前后10局，前10局 0 1 0 0 0 0 1 0 0 0,中国队落后很多，后10局 1 0 1 1 1 0 0 1 0 1,中国队奋起直追，追回了一些劣势

发现第四局中国队是先优势再劣势又优势的局面，挽回了中局时一度的败局，最终取得了第四局的胜利

接下来分析第五局

```{r}
for(r in 5:10){
  res<-sym_sign_test(r,g5)
  print(paste0("radius is : ",r," the round of pvalue<0.05 : ",(which(res<0.05)+r)))
  pval_plot(res, r)
}
```


发现我们无法找出在0.05显著性水平下的局点，第五局作为决胜局，双方僵持不下，更是达到了第32回合才决出胜负，但是中国对欠缺了一些运势，输掉了整场比赛。

纵观整场比赛，从得分序列对称比较的符号检验分析来看，中国队主要失败的原因是不能有效的将"优势"转变为"胜势"，也很难力挽狂澜，将败局逆转。输掉的比赛均是因为劣势期的连续失分太多，在优势期已经没有时间扳回。



